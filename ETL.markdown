نظام المزامنة والترجمة (ETL) الذي قمنا ببنائه في `SYS_DATA_MAP` يمتلك "ذكاءً مرناً" للتعامل مع المصادر الخارجية. هو لا يكتفي بمجرد نقل البيانات، بل يستخدم **5 طرق ربط** أساسية مع **4 أنماط مطابقة**.

إليك شرح لكل طريقة وكيف تعمل مع ملفاتك الخارجية (مثل Google Sheets):

---

### أولاً: أنواع ربط المصدر (`MapSourceType`)

هذه الأنواع تحدد للنظام "من أين" سيأتي بالقيمة:

#### 1. الربط باسم العمود (`Header`)
*   **كيف يعمل:** يبحث النظام في الصف الأول من ملف الإكسل/Google Sheet عن نص معين.
*   **الميزة:** إذا قام المستخدم بتغيير ترتيب الأعمدة في الإكسل (نقل عمود السعر من A إلى C)، سيظل النظام قادراً على إيجاده لأنه يبحث عن "الاسم" وليس "المكان".
*   **مثال:** `SourceExpression = "Unit Price"`.

#### 2. الربط بموقع العمود (`Index`)
*   **كيف يعمل:** يذهب النظام لعمود محدد بترتيبه الرقمي (0، 1، 2...).
*   **الميزة:** مفيد جداً عندما يكون ملف المصدر لا يحتوي على عناوين (Headers) أو عندما تكون العناوين بلغات مختلفة ولكن الترتيب ثابت.
*   **مثال:** `SourceExpression = "3"` (يعني جلب البيانات دائماً من العمود الرابع).

#### 3. الربط بالقيمة الثابتة (`Constant`)
*   **كيف يعمل:** لا ينظر النظام للملف الخارجي أصلاً، بل يضع قيمة ثابتة لكل السطور المستوردة.
*   **الميزة:** تستخدم لوسم البيانات.
*   **مثال:** تريد أن تضع كلمة "Imported" في عموم الملاحظات لكل البيانات القادمة من هذا الملف. `SourceExpression = "Imported"`.

#### 4. الربط بالسياق (`Context`)
*   **كيف يعمل:** يسحب القيمة من إعدادات المصدر نفسه (`DataSourceEntity`) وليس من سطور البيانات.
*   **الميزة:** تضمن توحيد البيانات. إذا كان ملف الإكسل لعمالة مصر لا يحتوي على عمود "البلد"، يقوم النظام بسحب قيمة `REGION` من جدول `SYS_DATA_SOURCES` ويحقنها في كل سطر.
*   **مثال:** جلب العملة (Currency) المحددة للمصدر ووضعها أمام كل سعر مستورد.

#### 5. الربط بالمعادلة (`Formula`)
*   **كيف يعمل:** يقوم المحرك بحساب قيمة جديدة بناءً على دمج أعمدة أخرى أو منطق برمجي.
*   **مثال:** دمج "كود المورد" مع "كود الخامة" لإنشاء مفتاح فريد جديد.

---

### ثانياً: أنماط المطابقة (`MapMatchMode`)

عندما نستخدم نوع الربط `Header` (الاسم)، نحتاج لتحديد "كيف" يطابق النظام هذا الاسم مع العمود في الإكسل:

1.  **المطابقة التامة (`Exact`):** يجب أن يتطابق اسم العمود في الإكسل مع `SourceExpression` حرفياً.
2.  **يحتوي (`Contains`):** يبحث عن أي عمود يحتوي على الكلمة (مثلاً: إذا بحثت عن "Price" سيجد عمود "Unit Price ($)").
3.  **يبدأ بـ (`StartsWith`):** يبحث عن الأعمدة التي تبدأ بكلمة معينة.
4.  **التعبيرات النمطية (`Regex`):** أقوى أنواع الربط؛ يسمح باستخدام رموز برمجية للبحث عن نمط معين (مثلاً: البحث عن أي عمود ينتهي بكلمة "Price" بغض النظر عما قبلها).

---

### ثالثاً: سلسلة التحويلات (`TransformChain`) - "المصفاة"

بعد نجاح الربط بأي طريقة من الطرق السابقة، تمر البيانات بـ **"خط إنتاج"** لتنظيفها وتجهيزها:

*   **`TRIM`**: إزالة المسافات الزائدة من البداية والنهاية.
*   **`UPPER/LOWER`**: توحيد حالة الأحرف (كبيرة/صغيرة).
*   **`REMOVE_SYMBOLS`**: تنظيف العملات من الرموز (مثل إزالة $ من أمام الرقم).
*   **`TO_DECIMAL`**: تحويل النص إلى رقم حقيقي ليتمكن المحرك الحسابي من استخدامه.

---

### مثال عملي يجمع كل ما سبق:

تخيل أنك تستورد ملف أسعار خامات من الصين:
1.  **الربط:** نستخدم `Header` بنمط `Contains` للبحث عن عمود اسمه "Cost".
2.  **السياق:** نستخدم `Context` لجلب "العملة" (CNY) من إعدادات المصدر.
3.  **التحويل:** نستخدم `TransformChain = "TRIM | REMOVE_SYMBOLS | TO_DECIMAL"` لضمان أن السعر أصبح رقماً نظيفاً.

**بهذا التصميم، نظامك يستطيع قراءة أي ملف خارجي مهما كان شكله، ويقوم بـ "ترجمته" فوراً ليفهمه محرك الأسعار الداخلي.**

هل تريد الانتقال الآن لتصميم جدول الـ **LOOKUP** الخاص بالعملات أو المناطق لنرى كيف يتم استدعاؤه؟



هذا النظام الذي قمنا ببنائه يدعم **5 طرق ربط أساسية**، تجعل منه نظاماً هجيناً يجمع بين صرامة قواعد البيانات ومرونة الإكسل. كل نوع من الربط له وظيفة محددة في رحلة البيانات.

إليك شرح مفصل لكل طريقة:

---

### 1. الربط الهيكلي المباشر (Direct Relation)
*   **المكان:** يتم تعريفه في `DataModelEntity` باستخدام `RelationType.DIRECT`.
*   **كيف يعمل:** هو ربط تقليدي (مثل Foreign Key). يربط عموداً في جدول (Parent) بعمود في جدول (Child).
*   **مثال هندسي:** ربط "كود الخامة" في جدول التكاليف بـ "كود الخامة" في جدول الموردين.
*   **الهدف:** جلب بيانات إضافية (مثل الاسم أو المواصفات) بناءً على مفتاح فريد.

### 2. الربط المتعدد الأوجه (Polymorphic Relation) - "الأذكى"
*   **المكان:** يتم تعريفه في `DataModelEntity` باستخدام `RelationType.POLYMORPHIC`.
*   **كيف يعمل:** الربط هنا ليس ثابتاً، بل يعتمد على "شرط" (Discriminator). النظام ينظر لعمود معين، وبناءً على قيمته يقرر لأي جدول سيذهب.
*   **مثال هندسي:** في جدول تحليل البنود (Assembly)؛ إذا كان نوع المورد `MAT` يذهب لجدول الخامات، وإذا كان `LAB` يذهب لجدول العمالة.
*   **الهدف:** السماح لجدول واحد (مثل BOQ) بالارتباط بعشرة جداول مختلفة دون تعقيد الهيكل.

### 3. الربط الدلالي (Semantic Linking) - "محرك الحسابات"
*   **المكان:** يتم تعريفه في `SchemaRuleEntity` عبر الـ `SemanticRole`.
*   **كيف يعمل:** هذا الربط لا يربط جداول، بل يربط **"وظائف الأعمدة"** بالمحرك الحسابي. النظام يبحث عن أي عمود يحمل دور `PRICE` وعمود يحمل دور `QTY` ليقوم بضربهما تلقائياً.
*   **مثال هندسي:** لا يهم إذا كان اسم العمود "السعر" أو "Rate" أو "UnitPrice"؛ طالما أن دوره الدلالي هو `PRICE` فالمحرك سيتعرف عليه.
*   **الهدف:** جعل المعادلات الحسابية ديناميكية وتعمل على أي جدول بمجرد تعريف "أدوار" أعمدته.

### 4. ربط المزامنة والترجمة (ETL Source Mapping)
*   **المكان:** يتم تعريفه في `DataMapEntity` و `DataSourceEntity`.
*   **كيف يعمل:** يربط بين "العالم الخارجي" (Google Sheets/Excel) و "النظام الداخلي". يحدد كيف يتحول العمود المسمى "Cost per Hour" في شيت خارجي إلى العمود `UNIT_PRICE` داخل نظامك.
*   **طرق الربط الفرعية هنا:**
    *   **Header Match:** الربط عن طريق اسم العمود.
    *   **Index Match:** الربط عن طريق ترتيب العمود (العمود رقم 1، رقم 2..).
    *   **Context Match:** ربط قيمة ثابتة (مثل المنطقة أو العملة) بكل السطور القادمة من هذا المصدر.
*   **الهدف:** استيراد البيانات من أي مكان مهما اختلف شكلها وتوحيدها داخل نظامك.

### 5. ربط التوريث (Definition Inheritance)
*   **المكان:** يتم تعريفه في `TableDefinitionEntity` عبر الـ `PARENT_KEY`.
*   **كيف يعمل:** يربط "تعريف جدول" بـ "تعريف جدول آخر". الجدول "الابن" يرث كل خصائص "الأب" (الأعمدة، الألوان، الصلاحيات) إلا إذا قمت بتغيير شيء معين.
*   **مثال هندسي:** تنشئ جدولاً أباً يسمى "قالب جداول العمالة" بكل قوانينه، ثم تنشئ منه "عمالة مصر" و "عمالة الهند". كلاهما سيرث نفس القوانين تلقائياً.
*   **الهدف:** تقليل تكرار الإعدادات وسهولة إدارة مئات الجداول بضغطة زر واحدة من خلال "الأب".

---

### ملخص الروابط (من منظور المحركات):

| نوع الربط | المحرك المسؤول (Engine) | متى يُستخدم؟ |
| :--- | :--- | :--- |
| **Direct** | `Join Engine` | عند البحث عن تفاصيل سجل معين. |
| **Polymorphic** | `Inference Engine` | عند بناء شجرة التكاليف المعقدة (Assemblies). |
| **Semantic** | `Calculation Engine` | عند إجراء عمليات الضرب والجمع والنسب (Tax/Waste). |
| **Mapping** | `ETL Engine` | عند سحب بيانات جديدة من Google Sheets. |
| **Inheritance** | `Metadata Engine` | عند إنشاء أو تعديل بنية الجداول. |

هذا التعدد في طرق الربط هو ما يجعل نظامك "عظيماً"؛ لأنه لا يعتمد على روابط جامدة (Hardcoded)، بل على **منطق وصفي (Metadata)** يفهم العلاقات الهندسية المعقدة.

**هل تريد مني توضيح أي نوع منها بمثال برمجي عملي (C#)؟**
